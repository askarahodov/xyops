name: Code Quality & AI Guidelines Check

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  validate-code:
    runs-on: ubuntu-latest
    name: Validate xyOps Code Quality

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Cache node modules
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Run validation (pre-commit checks)
        run: npm run validate

      - name: Run tests
        run: npm test

      - name: Check for blocking I/O
        run: |
          echo "Checking for blocking I/O in lib files..."
          if git diff origin/main..HEAD -- 'lib/*.js' | grep -E '\b(fs\.(readFileSync|writeFileSync|statSync)|require\(.*sync)' > /dev/null 2>&1; then
            echo "‚ùå FAIL: Found blocking I/O in lib files"
            echo "Use async versions: fs.readFile, fs.writeFile, fs.stat"
            exit 1
          else
            echo "‚úÖ PASS: No blocking I/O detected"
          fi

      - name: Check for unsafe activeJobs mutations
        run: |
          echo "Checking for unsafe activeJobs.workflow mutations..."
          if git diff origin/main..HEAD -- 'lib/*.js' | grep -E 'this\.activeJobs\[.*\]\.workflow.*=' > /dev/null 2>&1; then
            echo "‚ö†Ô∏è  WARNING: Found direct activeJobs.workflow modification"
            echo "Use jobDetails for workflow state, not activeJobs"
            echo "See: docs/AI_AGENT_ANALYSIS.md#job-state-duality"
          else
            echo "‚úÖ PASS: No unsafe workflow mutations detected"
          fi

      - name: Check for unnormalized storage keys
        run: |
          echo "Checking for unnormalized storage keys..."
          WARNINGS=0
          if git diff origin/main..HEAD -- 'lib/*.js' | grep -E "storage\.(get|put|delete|listFind)\('[a-z]" | grep -v normalizeKey; then
            echo "‚ö†Ô∏è  Found storage operations that may not normalize keys"
            echo "Use: this.storage.normalizeKey(userInput)"
            WARNINGS=$((WARNINGS + 1))
          fi
          if [ "$WARNINGS" -gt 0 ]; then
            echo "Review these carefully. Not a hard fail, but please verify."
          fi

      - name: Check API endpoints for loadSession
        run: |
          echo "Checking new API endpoints for loadSession..."
          NEW_ENDPOINTS=$(git diff origin/main..HEAD -- 'lib/api/*.js' | grep -E '^\+.*api_[a-z_]+\(' | wc -l)
          if [ "$NEW_ENDPOINTS" -gt 0 ]; then
            echo "‚ÑπÔ∏è  INFO: Found $NEW_ENDPOINTS new API endpoint(s)"
            echo "Verify they include: this.loadSession(args, (err, session, user) => {...})"
          fi

      - name: Check for CHANGELOG update
        run: |
          echo "Checking if CHANGELOG is updated..."
          if git diff origin/main..HEAD -- 'lib/api/*.js' | grep -q '.' && ! git diff origin/main..HEAD -- 'CHANGELOG.md' | grep -q '.'; then
            echo "‚ö†Ô∏è  WARNING: API changes without CHANGELOG update"
            echo "Update CHANGELOG.md for user-facing changes"
          fi

      - name: Comment on PR with guidelines
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');

            // Only comment once per PR to avoid spam
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botCommentExists = comments.some(comment =>
              comment.body.includes('xyOps Code Quality Guidelines')
            );

            if (!botCommentExists) {
              github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## ‚úÖ xyOps Code Quality Guidelines

This PR has been automatically validated against xyOps critical guidelines:

### Critical Checks Performed
- ‚úÖ No blocking I/O (\`fs.readFileSync\`)
- ‚úÖ Job state safety (jobDetails vs activeJobs)
- ‚úÖ Storage key normalization
- ‚úÖ API session handling
- ‚úÖ CHANGELOG updates

### Before Merging, Verify:
1. **Job State**: Changes go to \`jobDetails.wfJobData\`, NOT \`activeJobs.workflow\`
2. **Workflow Hierarchy**: state ‚Üí jobs ‚Üí wfJobData
3. **Async Patterns**: No blocking I/O, proper error handling
4. **API Validation**: Session + permissions + input checks
5. **Integration**: Satellite/server distribution considered

üìö **Reference Docs**:
- [Architecture Overview](../../.github/copilot-instructions.md)
- [Quick Reference](../../docs/QUICK_REFERENCE_AI.md)
- [Critical Issues Analysis](../../docs/AI_AGENT_ANALYSIS.md)

üöÄ See \`DEVELOPER_SETUP.md\` for contribution guidelines.`
              });
            }

  lint-check:
    runs-on: ubuntu-latest
    name: Lint & Format Check

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Check for TODO/FIXME markers
        run: |
          echo "Checking for unresolved TODO/FIXME markers..."
          if git diff origin/main..HEAD -- 'lib/**' | grep -E '^\+.*\b(TODO|FIXME|XXX|HACK)\b' > /dev/null 2>&1; then
            echo "‚ö†Ô∏è  Found unresolved markers. Please resolve before merge:"
            git diff origin/main..HEAD -- 'lib/**' | grep -E '\b(TODO|FIXME|XXX|HACK)\b'
          fi

      - name: Check code style
        run: |
          echo "Checking for consistent code style..."
          echo "Lines with trailing whitespace:"
          git diff origin/main..HEAD | grep -E '^\+.*\s+$' || echo "None found (good!)"
