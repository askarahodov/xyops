# Группы серверов

## Обзор

Группы серверов (часто просто "Groups") позволяют объединять несколько серверов в логические наборы и работать с ними как с единым целым. Один сервер может входить в любое количество групп. Группы используются для таргетинга событий (запуск задач по группе), агрегирования текущих и исторических представлений в UI, задания default alert actions, а также для group snapshots и watches.

Этот документ объясняет, что такое группы, как серверы попадают в группы (вручную и автоматически), как события таргетируются на группы и выбираются серверы, как работают default alert actions, как делать group snapshots и watches и что доступно на страницах групп в UI.

## Ключевые моменты

- Группы - это именованные коллекции серверов; один сервер может быть в нескольких группах.
- Серверы могут попадать в группы автоматически по regex на hostname, либо вы можете назначать их вручную.
- События могут таргетировать группы для запуска задач; xyOps выбирает один подходящий сервер из группы на каждую задачу по настраиваемому алгоритму.
- У каждой группы есть отдельная страница в UI с серверами группы, live статусом, мониторами, процессами, соединениями, задачами, будущими задачами и статистикой.
- Группы могут задавать default alert actions, которые срабатывают при алертах на любых серверах группы.
- Можно снять snapshot группы по запросу или настроить "watch" на снимки каждую минуту в течение заданного времени.

## Создание и редактирование групп

- **Location**: Sidebar -> Monitoring -> Groups.
- **Create**: Нажмите "New Group...", задайте title, опциональный icon и опциональный hostname regex для авто-назначения. Также можно добавить default alert actions и notes.
- **Edit**: Нажмите на группу -> Edit Group для изменения полей; ID неизменяем.
- **Reorder**: Перетаскивайте строки списка для сортировки.
- **Import/Export**: Используйте кнопки Import/Export на списке и в редакторе.
- **Permissions**: Для создания/редактирования/удаления групп нужны привилегии [create_groups](privileges.md#create_groups), [edit_groups](privileges.md#edit_groups) и [delete_groups](privileges.md#delete_groups) соответственно.

Поля группы:

- **Title**: Отображаемое имя группы.
- **Icon**: Опциональный Material Design Icon ID.
- **Hostname Match**: Regex для авто-назначения серверов по hostname. Оставьте пустым, чтобы не матчить ничего; используйте `.+` для всех серверов.
- **Alert Actions**: Default alert actions для алертов в группе (подробнее ниже).
- **Notes**: Опциональный свободный текст.

## Добавление серверов в группы

Серверы можно добавлять в группы двумя способами, и один сервер может входить в несколько групп одновременно.

1. **Автоматически по hostname**
	- Каждая группа может задать regex в `hostname_match`.
	- Когда сервер подключается (или меняется hostname), xyOps проверяет его по всем группам и назначает совпадающие группы.
	- Автоматическое назначение пересчитывается при изменении групп (create/edit/delete) и распространяется на серверы и storage.
	- Чтобы матчить все серверы, используйте `.+`.
2. **Ручное назначение для сервера**
	- На странице сервера выберите "Edit Server..." и задайте Groups, либо используйте "Add Server..." на странице группы.
	- При ручном назначении групп для сервера авто-группировка отключается для этого сервера.
	- Чтобы вернуть сервер в авто-назначение, очистите список групп вручную и включите Auto Group в редакторе сервера.

Примечания:

- Членство в группах аддитивное: сервер может быть в нескольких группах и автоматически, и вручную (если Auto Group не отключен вручным override).
- Таргетинг событий учитывает текущие live группы серверов; изменения вступают в силу сразу для новых задач.

## Default Alert Actions

Группы могут задавать default alert actions, которые срабатывают при любом алерте на сервере группы.

- В редакторе группы, раздел "Alert Actions".
- Когда срабатывают: при `alert_new` (алерт сработал) и/или `alert_cleared` (алерт снят), в зависимости от `condition` каждого action.
- Как объединяются: итоговый список actions для события алерта - это слияние:
	- actions самого определения алерта.
	- default actions всех групп сервера (для каждой группы, в которой состоит сервер).
	- universal alert actions из конфигурации.
	- Actions дедуплицируются по type + target (например, одни и те же email recipients или один и тот же web hook ID).
- Контекст: group actions включают контекст группы и сервера в уведомления (email/web hooks включают заголовки групп и ссылки).

См. [Actions](actions.md) для поддерживаемых типов и параметров.

## Таргетинг событий на группы

Вместо выбора конкретных серверов можно таргетировать одно или несколько Groups для события. При запуске задачи xyOps разворачивает группы в набор текущих онлайн и включенных серверов и выбирает один сервер по алгоритму выбора события.

Поведение:

- **Resolution**: `targets` события могут включать ID серверов и/или ID групп. Группы разворачиваются в текущих участников (на момент запуска).
- **Eligibility**: Учитываются только онлайн и включенные серверы. Серверы могут быть исключены, если активные алерты имеют "limit jobs" (настройка уровня алерта).
- **No servers available**: Если нет доступных серверов, xyOps может поставить задачу в очередь при наличии Queue limit; иначе задача сразу упадет. См. [Limits](limits.md#max-queue-limit).

Алгоритмы выбора:

- `random`: выбрать случайный сервер из подходящих.
- `round_robin`: циклический выбор по набору серверов для события; состояние сохраняется между запусками.
- `prefer_first`: выбрать первый сервер после сортировки по hostname (по возрастанию).
- `prefer_last`: выбрать последний сервер после сортировки по hostname (по возрастанию).
- `least_cpu`: выбрать сервер с наименьшей текущей средней нагрузкой CPU (`info.cpu.avgLoad`).
- `least_mem`: выбрать сервер с наименьшим текущим использованием памяти (`info.memory.active`).
- `monitor:<id>`: выбрать сервер с минимальным значением указанного monitor.

Детали:

- Набор кандидатов дедуплицируется и строится из всех целей (группы и серверы), затем фильтруется по online/enabled и исключению по алертам.
- Для `round_robin` xyOps хранит состояние ротации для события, так что распределение остается честным при рестартах или failover conductors.

См. [Events -> Server Selection](events.md#server-selection) и [Data -> Event.algo](data.md#event-algo) для контекста.

## Group Snapshots и Watches

Snapshots фиксируют состояние группы на момент времени (с участниками, метриками, задачами и алертами). Watches автоматизируют снимки каждую минуту на протяжении заданной длительности.

- **Take snapshot**: на странице группы нажмите "Snapshot". Требуется привилегия [create_snapshots](privileges.md#create_snapshots).
- **Group watch**: нажмите кнопку Watch, задайте длительность, и xyOps будет делать снимки каждую минуту до истечения длительности. Установите 0 для отмены.
- **History**: снимки групп отображаются на странице Snapshots и имеют ссылки на группу.
- **Contents**: snapshot группы включает определение группы, подходящие серверы, последнюю минуту "quick" метрик каждого сервера, активные задачи на этих серверах и алерты, затрагивающие группу.

См. также: [Snapshots](snapshots.md) и [Data -> GroupSnapshot](data.md#groupsnapshot).

## UI группы

У каждой группы есть отдельный live view, который агрегирует всех участников. В Monitoring -> Groups нажмите на группу, чтобы открыть страницу.

Что видно:

- Summary: ID/название/иконка группы, hostname match regex, количество серверов, количество alert actions, автор, created/modified и breakdown парка (архитектуры, ОС, типы CPU, виртуализация).
- Controls: Edit Group, Snapshot, Watch, Add Server, а также ссылки на Group History, Alert History и Job History.
- Таблица серверов: все серверы группы (онлайн и недавно офлайн), со статусом, resource donut диаграммами, running jobs и контролами. Поддерживает фильтры и выделение.
- Quick Look: live графики с секундным разрешением по CPU, памяти, диску и сети для видимых серверов за последнюю минуту.
- Memory и CPU details: агрегированная разбивка памяти/CPU по серверам с режимами объединения для компактного вида.
- Monitors: последний час настроенных monitors, с фильтрами и размерами графиков; один слой на сервер.
- Processes и Connections: агрегированные таблицы процессов и активных сетевых соединений по группе с фильтрами.
- Jobs: активные задачи, выполняющиеся на серверах группы, с прогресс-барами и оставшимся временем.
- Upcoming jobs: прогноз будущих задач, которые попадут на сервера группы (на основе расписаний событий, таргетирующих группу).
- Alerts: активные алерты, затрагивающие серверы группы, со ссылками на детали.

## API

Эндпойнты, которые используются для групп в UI и автоматизации:

- List groups: `app/get_groups`
- Get group: `app/get_group`
- Create group: `app/create_group`
- Update group: `app/update_group`
- Delete group: `app/delete_group`
- Reorder groups: `app/multi_update_group`
- Create group snapshot: `app/create_group_snapshot`
- Set/cancel watch: `app/watch_group`

См. [API](api.md) для деталей запросов/ответов.

## Лучшие практики

- Предпочитайте автоматическую группировку с понятными и стабильными шаблонами hostname (например, префиксы окружения или роли). Для исключений используйте ручное назначение.
- Используйте несколько групп для ортогональных понятий (например, "prod", "db", "east"), затем таргетируйте события на несколько групп по необходимости.
- Комбинируйте default alert actions групп с действиями на уровне алертов, чтобы централизовать on-call маршрутизацию.
- Для разнородных парков рассмотрите выбор по `monitor:<id>` для распределения задач по текущей нагрузке.
