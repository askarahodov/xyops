# Пользователи и роли

## Обзор

Этот документ объясняет, как работают учетные записи, роли и права в xyOps. Платформа включает управление аккаунтами (создание, вход, сессии, сброс пароля) и расширяет это ролями, ограничениями ресурсов, логированием безопасности, аватарами и админ-инструментами.

- Базовая система аккаунтов: встроенная аутентификация, управление сессиями и парольные потоки.
- Расширения: роли и эффективные привилегии, ограничения категорий/групп, security log пользователя, "Logout All Sessions", аватары и расширенные UI предпочтения.
- Админы управляют пользователями и ролями в Admin UI; все изменения применяются на backend.

См. также:

- Определения объектов [User](data.md#user) и [Role](data.md#role).
- [Список привилегий](privileges.md)
- [SSO Integration](sso.md)

## Профиль пользователя

Каждый пользователь представляет один человеческий аккаунт. Профиль объединяет идентичность, аутентификацию, права и UI предпочтения. Полную JSON схему см. в [User](data.md#user).

- **Identity**: `username` (уникален), `full_name` (отображаемое имя), `email` (контакт).
- **Status**: `active` (true/false для активен/заморожен). Замороженные пользователи не могут входить.
- **Authentication**: `password` (bcrypt hash), `salt` (per-user). Пароли в открытом виде не хранятся.
- **Roles**: массив `roles` с ID ролей; см. Roles ниже.
- **Privileges**: объект `privileges` (ключи дают права). См. [Privileges](privileges.md).
- **Resource limits**: массивы `categories` и `groups` ограничивают доступ к категориям событий и группам серверов.
- **Preferences**: UI/locale опции, включая `language`, `region`, `num_format`, `hour_cycle`, `timezone`, `color_acc`, `privacy_mode`, `effects`, `contrast`, `motion`, `volume` и сохраненные `searches`.
- **Avatar**: опциональное изображение профиля. Загружается/заменяется в UI.

Примечания:

- Специальная привилегия `admin` дает полный доступ ко всем текущим и будущим возможностям и обходит ограничения категорий/групп.
- xyOps может ставить внутренние флаги для SSO-аккаунтов (например, `remote`, `sync`); см. [SSO](sso.md).

## Роли

Роль объединяет набор привилегий и опциональные ограничения ресурсов. Назначайте роли пользователям, чтобы упростить управление правами. Полную JSON схему см. в [Role](data.md#role).

- **Privileges**: объект `privileges` роли добавляет права назначенным пользователям.
- **Category restrictions**: `categories` ограничивают доступ к конкретным категориям событий.
- **Group restrictions**: `groups` ограничивают доступ к конкретным группам серверов.
- **Enabled flag**: только включенные роли добавляют права пользователю.

Админы могут создавать, редактировать, включать/выключать и удалять роли в Admin UI. При изменении ролей сокеты пользователей обновляются, и активные сессии сразу получают новые права.

## Эффективные права

xyOps вычисляет эффективную авторизацию пользователя, объединяя прямые назначения и права из ролей. Привилегии складываются при слиянии с назначенными ролями.

- Объединение привилегий: привилегии аккаунта и ролей объединяются.
- Лимиты категорий и групп: если не заданы, у пользователя доступ ко "всем" категориям или группам.
- Admin override: если `admin` есть напрямую или через роль, пользователь может выполнять любое действие и не ограничен категориями/группами.

Как применяется контроль:

- Проверки API: backend проверяет привилегии на каждом вызове и проверяет доступ к категориям/группам/целям.
- Фильтрация UI: списки и контролы в UI учитывают эффективные права и ограничения ресурсов; недоступные элементы скрываются или блокируются.

Полный список privilege IDs см. в [Privileges](privileges.md). Привилегия `admin` особая и включает все остальные.

## Ограничения ресурсов

Пользователей можно ограничить конкретными категориями событий и/или группами серверов:

- Категории: если у пользователя/роли задан `categories`, пользователь видит и управляет событиями только в этих категориях. Если `categories` не задан, разрешены все категории (если не запрещено правами).
- Группы: если у пользователя/роли задан `groups`, цели задач должны пересекаться с этими группами. Если `groups` не задан, разрешены все группы (в рамках прав). Проверка идет по группам; на уровне отдельных серверов гранулярности нет.
- Admin bypass: администраторы не ограничены категориями/группами.

Типовые сценарии:

- Разделение по отделам: назначьте роли, разрешающие только категории "Dev" или "Ops".
- Разделение окружений: ограничьте конкретных пользователей группой "Staging", но не "Production".

## Сессии и аутентификация

xyOps управляет созданием аккаунтов, входом, сессиями и сбросом пароля, а также ведет лог активности.

- Срок жизни: сессии истекают согласно настройке [User.session_expire_days](config.md#user-session_expire_days).
- Блокировки: несколько неудачных логинов в час приводят к блокировке с требованием сброса пароля (настраивается). Админы могут "Reset Lockouts" для пользователя.
- Управление паролями: пользователи могут менять пароль (нужно указать текущий). Есть потоки "забыли пароль" и "сброс" через email шаблоны.
- Single Sign-On: xyOps поддерживает SSO через trusted headers (например, OAuth2-Proxy), может автоназначать роли/права по группам IdP и редиректить при logout. См. [SSO](sso.md).

## Security Log

xyOps записывает активности аккаунтов в security log пользователя и в системный activity log.

- User security log: включает вход, обновления профиля, смену пароля, уведомления/предупреждения и метаданные IP/user-agent. Доступен в UI в разделе Security Log.
- System activity log: расширенный аудит лог для всех действий системы (для админов).
- Parsed user agents: UI показывает человекочитаемые строки user agent при наличии.

Logout All Sessions:

- Пользователь может завершить все остальные сессии после ввода текущего пароля. Текущая сессия остается активной.
- Админы могут принудительно выполнить "Logout All Sessions" для любого пользователя. Также отправляется summary email при завершении сессий.

## Админские задачи

Администраторы могут выполнять следующие действия из Admin UI или через API:

- **Create users**: задать username, display name, email, initial password, privileges/roles; опционально отправить welcome email.
- **Edit users**: обновить профиль, сменить пароль, настроить privileges/roles, назначить ограничения категорий/групп, переключить active/suspended.
- **Unlock accounts**: сбросить блокировки и throttles, если аккаунт заблокирован из-за failed logins.
- **Delete users**: удалить аккаунт и security log пользователя; активные сокеты закрываются.
- **Force logout**: поставить background job на завершение всех остальных сессий пользователя.
- **Manage roles**: создать/обновить роли с привилегиями и лимитами категорий/групп; включать/выключать роли.
